<html>
    <head>
        <title>Liveness Check Demo</title>
    </head>
    <body>
        <script src="./face-api.js"></script>
        
        <div style="text-align: center;">
            <div style="width: 100%; max-width: 800px; display: inline-block; background-color: #222;">
                <div style="text-align: center; padding: 20px;">
                    <progress id="progress" max="6" value="0"></progress>
                    <h2 id="task">
                        Loading...
                    </h2>
                </div>
                <div class="container">
                    <video autoplay="true" id="video" onloadeddata="onPlay(this)"></video>
                    <canvas id="overlay"></canvas>
                    <div id="start">
                        <div id="button">Start Verification</div>
                    </div>
                </div>
                <div style="text-align: left; padding: 20px;">
                    <input type="checkbox" id="debugToggle"> Debug
                    <div id="status" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
        
        <style>
            body {
                background-color: #111;
                color: #fff;
                font-family: sans-serif;
            }
        
            .container {
                display: grid;
                grid-template-areas: "block";
            }
        
            #video, #overlay, #start {
                grid-area: block;
                width: 100%;
            }
        
            #start {
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: rgb(255 255 255 / 79%);
                width: 100%;
                z-index: 999;
            }
        
            #button {
                padding: 10px 20px;
                border-radius: 4px;
                text-align: center;
                font-size: 4vh;
                cursor: pointer;
                font-weight: 100;
                background-color: #68b868;
                display: none;
            }
        </style>
        
        <script>
            let debug = false;
        
            const inputSize = 256;
            const scoreThreshold = 0.5;
            const options = new faceapi.TinyFaceDetectorOptions({inputSize, scoreThreshold});
        
            const checks = {
                default: {
                    message: "Please look straight at the camera",
                    check: state => state.position === 'straight',
                },
                turn_left: {
                    message: "Please turn your head to the left",
                    check: state => state.position === 'turn left',
                },
                turn_right: {
                    message: "Please turn your head to the right",
                    check: state => state.position === 'turn right',
                },
                tilt_left: {
                    message: "Please tilt your head to the left",
                    check: state => state.position === 'tilt left',
                },
                tilt_right: {
                    message: "Please tilt your head to the right",
                    check: state => state.position === 'tilt right',
                },
                smile: {
                    message: "Please smile :)",
                    check: state => state.smile,
                },
            };
        
            const tasks = Object.keys(checks).filter(name => name !== 'default');
        
            const video = document.querySelector("#video");
            const overlay = document.querySelector("#overlay");
            const canvas = overlay.getContext('2d');
            const status = document.querySelector("#status");
            const task = document.querySelector("#task");
            let progress = document.querySelector("#progress");
            const button = document.querySelector("#button");
        
            document.querySelector('#debugToggle').onclick = () => debug = !debug;
        
            (async function () {
                video.srcObject = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: {
                        width: { min: 1024, ideal: 1280, max: 1920 },
                        height: { min: 720, ideal: 960, max: 1080 },
                        // facingMode: { exact: mode }
                    }
                });
        
                progress.value = 1;
            })();
        
            const detect = async (stream) => await faceapi.detectSingleFace(stream, options)
                .withFaceLandmarks()
                .withFaceExpressions();
        
            const average = (nums, getter) => nums.reduce((a, b) => (a + getter(b)), 0) / nums.length;
            const distance = (p1, p2) => Math.sqrt((p2.x - p1.x) ** 2  + (p2.y - p1.y) ** 2);
            const percentage = (v1, v2) => ((v2 - v1) / Math.abs(v1)) * 100;
            const wait = ms => new Promise((res) => setTimeout(res, ms));
        
            const getStatus = (result) => {
                const state = {
                    position: 'unrecognized',
                    details: 0,
                    smile: false,
                }
        
                if (!result) {
                    return state;
                }
        
                const {landmarks, expressions} = result;
        
                state.position = 'straight';
        
                const eyesResult = percentage(
                    average(landmarks.getLeftEye(), point => point.y),
                    average(landmarks.getRightEye(), point => point.y)
                );
        
                if (Math.abs(eyesResult) > 10) {
                    state.position = `tilt ${eyesResult > 0 ? 'left' : 'right'}`;
                    state.details = eyesResult;
                }
        
                const nose = landmarks.getNose();
                const noseResult = percentage(
                    distance(nose[3], nose[4]),
                    distance(nose[3], nose[8]),
                );
        
                if (noseResult < -50) {
                    state.position = `turn left`;
                    state.details = noseResult;
                }
        
                if (noseResult > 100) {
                    state.position = `turn right`;
                    state.details = noseResult;
                }
        
                state.smile = expressions.happy.toFixed(1) > .8;
        
                return state;
            };
        
            let currentTask = 'default';
            let taskCounter = 0;
            let verificationStarted = false;
        
            button.onclick = () => {
                document.querySelector('#start').remove();
        
                verificationStarted = true;
            }
        
            const changeTask = async () => {
                verificationStarted = false;
        
                task.innerHTML = "Fine! 👍";
        
                await wait(2000);
        
                currentTask = tasks[(Math.random() * 5) >> 0];
                taskCounter = 0;
        
                task.innerHTML = "Waiting... ⏳";
                verificationStarted = true;
            };
        
            async function onPlay (stream) {
                progress.value = 2;
        
                const dims = faceapi.matchDimensions(overlay, stream, true)
        
                await faceapi.loadTinyFaceDetectorModel('./models');
                progress.value = 3;
        
                await faceapi.loadFaceExpressionModel('./models');
                progress.value = 4;
        
                await faceapi.loadFaceLandmarkModel('./models');
                progress.value = 5;
        
                const frame = async () => {
                    const result = await detect(stream);
        
                    if (result) {
                        const frameStatus = getStatus(result);
        
                        if (verificationStarted) {
                            task.innerHTML = checks[currentTask].message;
        
                            if (checks[currentTask].check(frameStatus)) {
                                taskCounter++;
                            }
        
                            if (taskCounter > 3) {
                                changeTask();
                            }
                        }
        
                        canvas.clearRect(0, 0, overlay.width, overlay.height);
        
                        if (debug) {
                            faceapi.draw.drawFaceLandmarks(
                                overlay,
                                faceapi.resizeResults(result, dims)
                            )
                        }
        
                        if (progress) {
                            progress.remove();
                            progress = false;
        
                            button.style.display = "initial";
        
                            task.innerHTML = "";
                        }
        
                        status.innerHTML = debug ? ((JSON.stringify(frameStatus) + `. Task: ${currentTask}, Counter: ${taskCounter}`)) : '';
                    } else {
                        status.innerHTML = debug ? 'Face not found' : '';
                    }
        
                    requestAnimationFrame(frame);
                };
        
                frame();
            }
        </script>
    </body>
</html>